# Farming Plan System - Mathematical Scheduling

## Overview

The farming plan system uses **mathematical scheduling rules** generated by Gemini AI that automatically expand into daily calendar entries. This avoids the need for Gemini to generate every single day's tasks.

## How It Works

### 1. Gemini Generates Mathematical Rules

When a farmer creates a plan, Gemini generates:

```json
{
  "version": 1,
  "title": {
    "en": "Rice Cultivation Plan - 2.5 Acres",
    "hi": "चावल की खेती योजना - 2.5 एकड़",
    "bn": "ধান চাষ পরিকল্পনা - 2.5 একর"
  },
  "wateringRules": [
    {
      "startDay": 0,
      "endDay": 30,
      "everyDays": 2,
      "timeOfDay": "morning",
      "timeHHmm": "07:00",
      "title": {
        "en": "Early stage irrigation",
        "hi": "प्रारंभिक सिंचाई",
        "bn": "প্রাথমিক সেচ"
      },
      "notes": {
        "en": "Keep soil moist during germination",
        "hi": "अंकुरण के दौरान मिट्टी को नम रखें",
        "bn": "অঙ্কুরোদগমের সময় মাটি আর্দ্র রাখুন"
      }
    }
  ],
  "recurringTasks": [
    {
      "type": "fertilizer",
      "startDay": 15,
      "endDay": 90,
      "everyDays": 15,
      "timeOfDay": "morning",
      "timeHHmm": "08:00",
      "title": {
        "en": "Apply organic fertilizer",
        "hi": "जैविक उर्वरक डालें",
        "bn": "জৈব সার প্রয়োগ করুন"
      }
    }
  ]
}
```

### 2. System Expands Rules Mathematically

The `expandInRangeFromRules` function in `farmingPlan.ts` takes these rules and generates actual calendar entries:

**Example Watering Rule:**
```javascript
{
  startDay: 0,    // Day 0 = planting date
  endDay: 30,     // Continue until day 30
  everyDays: 2    // Every 2 days
}
```

**Expands to Calendar Entries:**
- Day 0 (Planting date): Irrigate at 7:00 AM
- Day 2: Irrigate at 7:00 AM  
- Day 4: Irrigate at 7:00 AM
- Day 6: Irrigate at 7:00 AM
- ... continues until Day 30

**Example Fertilizer Task:**
```javascript
{
  startDay: 15,
  endDay: 90,
  everyDays: 15
}
```

**Expands to:**
- Day 15: Apply fertilizer
- Day 30: Apply fertilizer
- Day 45: Apply fertilizer
- Day 60: Apply fertilizer
- Day 75: Apply fertilizer
- Day 90: Apply fertilizer

### 3. Multilingual Support

All text is generated by Gemini in **three languages simultaneously**:
- **English (en)**: For English-speaking farmers
- **Hindi (hi)**: For Hindi-speaking farmers  
- **Bengali (bn)**: For Bengali-speaking farmers

The calendar UI automatically displays the correct language based on user preference:

```javascript
// User with language = "bn" sees:
title: "ধান চাষ পরিকল্পনা - 2.5 একর"
task: "প্রাথমিক সেচ"
notes: "অঙ্কুরোদগমের সময় মাটি আর্দ্র রাখুন"

// User with language = "hi" sees:
title: "चावल की खेती योजना - 2.5 एकड़"
task: "प्रारंभिक सिंचाई"
notes: "अंकुरण के दौरान मिट्टी को नम रखें"
```

## Advantages of Mathematical Scheduling

1. **Efficiency**: Gemini generates ~10-20 rules instead of 100+ individual tasks
2. **Flexibility**: Rules can span entire crop cycle (0-120+ days)
3. **Accuracy**: No risk of missing days due to manual entry
4. **Scalability**: Works for any crop duration (30 days to 365+ days)
5. **Performance**: Calendar loads instantly with on-demand expansion
6. **Multilingual**: One rule = translations in all languages

## File Structure

- **src/services/gemini.ts**: Contains `generateLocalizedFarmingPlanV1()` with prompt engineering for mathematical rules
- **src/services/farmingPlan.ts**: Contains expansion logic (`expandInRangeFromRules`, `expandUpcomingFromRules`)
- **src/screens/PlanCalendarScreen.tsx**: Calendar UI that displays expanded tasks
- **src/screens/FarmerDailyRoutine.tsx**: Daily task view with time-of-day scheduling

## Example: Complete Rice Plan (120 days)

Instead of Gemini generating 120+ individual tasks, it generates:

- **3-5 watering rules** (e.g., every 2 days for 0-30, every 3 days for 31-90)
- **5-8 recurring tasks** (fertilizer every 15 days, field scouting weekly)
- **4-6 one-off milestones** (land prep, transplanting, harvest prep)

= **~15 rules** that expand to **100+ calendar entries automatically**

## Validation & Harvest Date Analysis

Gemini also validates the farmer's expected harvest date:

```javascript
// If farmer provides unrealistic date:
plantingDate: "2026-01-15"
expectedHarvestDate: "2026-02-01"  // Only 17 days for rice!

// Gemini corrects it:
{
  "dates": {
    "expectedHarvestDateISO": "2026-05-15"  // Realistic 120 days
  },
  "overview": {
    "en": "Your harvest date has been adjusted to May 15, 2026 (120 days) for optimal yield..."
  }
}
```

This ensures farmers get realistic schedules even if they make data entry mistakes.
